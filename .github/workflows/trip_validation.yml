name: Trip Simulation and AWS Logging

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  validate_trip:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_BUCKET_NAME: 'githubactionrunnerlogs'

    steps:
      - name: â¬‡ï¸ Checkout Repository Code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ Install Dependencies
        run: pip install pandas boto3

      - name: ðŸƒ Run Trip A Simulation
        run: python simulate_trip_a.py

      - name: âœ… Verify trip_a_generated.csv exists
        run: |
          echo "Files in current directory:"
          ls -l trip_a_generated.csv
          echo "--- First 10 lines of the CSV ---"
          head -n 10 trip_a_generated.csv

      - name: âš–ï¸ Run Trip Comparison
        run: python compare_trips.py

      - name: ðŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: â¬†ï¸ Upload Log to S3
        run: |
          S3_KEY="logs/${{ github.sha }}/trip_comparison.log"
          echo "Uploading trip_comparison.log to s3://${{ env.AWS_BUCKET_NAME }}/$S3_KEY"
          aws s3 cp trip_comparison.log s3://${{ env.AWS_BUCKET_NAME }}/$S3_KEY

      - name: ðŸ“„ Upload as GitHub Artifact
        uses: actions/upload-artifact@v4
        with:
          name: trip-comparison-log-github
          path: trip_comparison.log
          retention-days: 7

      - name: âœ… Check and Report Status
        run: |
          echo "--- Comparison Results ---"
          cat trip_comparison.log
          echo "--------------------------"

      # ðŸ”½ NEW STEPS FOR DOCKER & KUBERNETES ðŸ”½
      - name: ðŸ³ Build Docker Image
        run: |
          docker build -t trip-simulation:latest .

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: ðŸ³ Push Docker Image
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/trip-simulation:latest
          docker tag trip-simulation:latest $IMAGE_NAME
          docker push $IMAGE_NAME
          
      - name: Configure Kubeconfig for EKS
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > ~/.kube/config

      - name: âœ… Verify EKS Cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
