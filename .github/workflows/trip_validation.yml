name: Trip Simulation and EKS Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  trip_pipeline:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_BUCKET_NAME: ${{ secrets.AWS_BUCKET_NAME }}
      IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/trip-simulation:latest

    steps:
      # 1. Checkout Code
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # 2. Setup Python
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 3. Install Dependencies
      - name: âš™ï¸ Install Dependencies
        run: pip install -r requirements.txt

      # 4. Run Simulation
      - name: ðŸƒ Run Trip A Simulation
        run: python simulate_trip_a.py

      # 5. Verify CSV
      - name: âœ… Verify trip_a_generated.csv
        run: |
          ls -l trip_a_generated.csv
          head -n 10 trip_a_generated.csv

      # 6. Compare Trips
      - name: âš–ï¸ Run Trip Comparison
        run: python compare_trips.py

      # 7. Configure AWS Credentials
      - name: ðŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 8. Upload Log to S3
      - name: â¬†ï¸ Upload Log to S3
        run: |
          S3_KEY="logs/${{ github.sha }}/trip_comparison.log"
          aws s3 cp trip_comparison.log s3://${{ env.AWS_BUCKET_NAME }}/$S3_KEY

      # 9. Upload GitHub Artifact
      - name: ðŸ“„ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: trip-comparison-log
          path: trip_comparison.log
          retention-days: 7

      # 10. Build Docker Image
      - name: ðŸ³ Build Docker Image
        run: docker build -t trip-simulation:latest .

      # 11. Login to Docker Hub
      - name: ðŸ” Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 12. Push Docker Image
      - name: ðŸ³ Push Docker Image
        run: |
          docker tag trip-simulation:latest $IMAGE_NAME
          docker push $IMAGE_NAME

      # 13. Configure Kubeconfig for EKS
      - name: ðŸ”§ Configure Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > ~/.kube/config

      # 14. Deploy to EKS
      - name: ðŸš€ Deploy to EKS
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      # 15. Install ADOT Collector for Monitoring
      - name: ðŸ“Š Install ADOT Collector
        run: |
          kubectl apply -f https://github.com/aws-observability/aws-otel-collector/releases/latest/download/aws-otel-collector.yaml
