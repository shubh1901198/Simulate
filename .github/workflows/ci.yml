name: CI - K8s Simulate & Deploy (Single Job Pipeline)

# Runs the workflow only via push to main or manual trigger
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write # Needed for pushing to GHCR

env:
  # Define standard names for the final artifacts
  IMAGE_NAME_FULL: ghcr.io/${{ github.repository_owner }}/trip-simulation:latest
  FINAL_LOG_NAME: final-k8s-simulation-log.txt
  FINAL_CSV_NAME: final-k8s-simulation-data.csv

jobs:
  full-k8s-pipeline:
    name: Build, Push, and Run Simulation in KinD
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- 1. BUILD AND PUSH IMAGE ---
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Pull Image and Load into KinD
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/trip-simulation:latest
          docker pull "$IMAGE" 
          
          # Now load the image into the KinD cluster
          kind load docker-image "$IMAGE"

      # --- 2. K8s SETUP AND EXECUTION ---
      
      - name: Create Artifact Volume Directory
        # This directory on the runner acts as the hostPath for the K8s Job
        run: mkdir -p ${{ github.workspace }}/k8s-artifacts

      - name: Install KinD and Kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          [ "$(uname -m)" = x86_64 ] && curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo install ./kind /usr/local/bin/kind
          
      - name: Create KinD Cluster and Expose Volume
        # This config exposes the k8s-artifacts directory to the cluster node
        run: |
          kind create cluster --config - <<EOF
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            extraMounts:
            - hostPath: ${{ github.workspace }}/k8s-artifacts
              containerPath: /mnt/artifacts
          EOF
          
      - name: Load Docker Image into KinD Cluster (Crucial Step)
        # Load the image just built into the KinD node's Docker daemon so K8s can find it.
        run: kind load docker-image ${{ env.IMAGE_NAME_FULL }}
        
      - name: Verify KinD Cluster Access
        run: kubectl wait --for=condition=Ready node/kind-control-plane --timeout=60s

      - name: Apply Job YAML
        run: kubectl apply -f k8s/job.yaml

      - name: Wait for Job completion
        run: kubectl wait --for=condition=complete --timeout=120s job/trip-simulation-job

      # --- 3. LOG AND ARTIFACT RETRIEVAL ---

      - name: Capture K8s Job logs
        run: |
          echo "--- KUBERNETES JOB EXECUTION LOGS (Pod Console) ---" > ${{ env.FINAL_LOG_NAME }}
          POD=$(kubectl get pods --selector=job-name=trip-simulation-job -o jsonpath='{.items[0].metadata.name}')
          kubectl logs "$POD" >> ${{ env.FINAL_LOG_NAME }}
          
      - name: Retrieve CSV Artifact from Mounted Volume
        # The CSV written by the K8s Pod is now on the host runner in k8s-artifacts.
        run: mv ${{ github.workspace }}/k8s-artifacts/trip_a_generated.csv ${{ env.FINAL_CSV_NAME }}

      - name: Upload Final Combined Log and Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: final-k8s-report-${{ github.run_id }}
          path: |
            ${{ env.FINAL_LOG_NAME }}
            ${{ env.FINAL_CSV_NAME }}

      # --- 4. NOTIFICATION ---
      - name: Send Email with Artifacts ðŸ“§
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          
          subject: 'K8s Simulation ${{ github.run_id }} Complete: Trip Simulation Report'
          body: |
            The CI/CD workflow for ${{ github.repository }} has completed, running the simulation entirely within a Kubernetes Job.
            
            Find the combined simulation logs and the generated CSV attached.
            
            Workflow Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
          to: 'recipient@example.com'
          from: 'sender@example.com'
          attachments: ${{ env.FINAL_LOG_NAME }}, ${{ env.FINAL_CSV_NAME }}
          if: always()
