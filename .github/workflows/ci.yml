name: CI - K8s Simulate & Deploy (Single Job Pipeline)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/trip-simulation:latest
  ARTIFACT_DIR: ${{ github.workspace }}/k8s-artifacts
  FINAL_LOG: final-k8s-simulation-log.txt
  FINAL_CSV: final-k8s-simulation-data.csv

jobs:
  full-k8s-pipeline:
    name: Build → Run Kubernetes Simulation → Collect Artifacts
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # 1. CHECKOUT
    # -----------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -----------------------------
    # 2. BUILD DOCKER & PUSH
    # -----------------------------
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to GHCR
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build image and load locally for KinD
      uses: docker/build-push-action@v4
      with:
        context: .
        file: Dockerfile
        load: true
        tags: ${{ env.IMAGE_NAME }}

    - name: Push image to GHCR
      run: docker push ${{ env.IMAGE_NAME }}

    # -----------------------------
    # 3. K8S CLUSTER SETUP (KinD)
    # -----------------------------
    - name: Create Artifact Volume Directory
      run: mkdir -p ${{ env.ARTIFACT_DIR }}

    - name: Install KinD & kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

        curl -Lo kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
        chmod +x kind
        sudo mv kind /usr/local/bin/

    - name: Generate KinD Config
      run: |
        cat <<EOF > kind-config.yaml
        kind: Cluster
        apiVersion: kind.x-k8s.io/v1alpha4
        nodes:
        - role: control-plane
          extraMounts:
          - hostPath: ${{ env.ARTIFACT_DIR }}
            containerPath: /mnt/artifacts
        EOF

    - name: Create KinD cluster
      run: kind create cluster --config kind-config.yaml

    - name: Load image into KinD
      run: kind load docker-image ${{ env.IMAGE_NAME }}

    - name: Verify KinD cluster ready
      run: kubectl wait --for=condition=Ready node/kind-control-plane --timeout=90s

    # -----------------------------
    # 4. APPLY K8S JOB
    # -----------------------------
    - name: Apply Simulation Job
      run: kubectl apply -f k8s/job.yaml

    - name: Wait for Job completion
      run: kubectl wait --for=condition=complete --timeout=600s job/trip-simulation-job

    # -----------------------------
    # 5. AUTO-DEBUG ON FAILURE
    # -----------------------------
    - name: Debug Kubernetes Job (on failure)
      if: failure()
      run: |
        echo "=== JOB DESCRIBE ==="
        kubectl describe job trip-simulation-job || true

        echo "=== POD LIST ==="
        kubectl get pods -o wide || true

        POD=$(kubectl get pods --selector=job-name=trip-simulation-job -o jsonpath='{.items[0].metadata.name}')
        echo "Using Pod: $POD"

        echo "=== POD DESCRIBE ==="
        kubectl describe pod "$POD" || true

        echo "=== POD LOGS ==="
        kubectl logs "$POD" --all-containers || true

    # -----------------------------
    # 6. COLLECT ARTIFACTS
    # -----------------------------
    - name: Collect artifacts from container
      run: |
        LOG=${{ env.FINAL_LOG }}

        POD=$(kubectl get pods --selector=job-name=trip-simulation-job -o jsonpath='{.items[0].metadata.name}')

        echo "--- KUBERNETES POD LOGS ---" > "$LOG"
        kubectl logs "$POD" --all-containers >> "$LOG" || echo "No pod logs." >> "$LOG"

        # Trip comparison log
        if [ -f "${{ env.ARTIFACT_DIR }}/trip_comparison.log" ]; then
          echo -e "\n--- TRIP COMPARISON LOG ---\n" >> "$LOG"
          cat "${{ env.ARTIFACT_DIR }}/trip_comparison.log" >> "$LOG"
        else
          echo "trip_comparison.log missing!" >> "$LOG"
        fi

        # Trip A CSV
        if [ -f "${{ env.ARTIFACT_DIR }}/trip_a_generated.csv" ]; then
          mv "${{ env.ARTIFACT_DIR }}/trip_a_generated.csv" "${{ env.FINAL_CSV }}"
        else
          echo "CSV missing!" >> "${{ env.FINAL_CSV }}"
        fi

    - name: Upload final logs and CSV
      uses: actions/upload-artifact@v4
      with:
        name: final-k8s-report-${{ github.run_id }}
        path: |
          ${{ env.FINAL_LOG }}
          ${{ env.FINAL_CSV }}

    # -----------------------------
    # 7. EMAIL NOTIFICATION
    # -----------------------------
    - name: Send email with artifacts
      uses: dawidd6/action-send-mail@v6
      if: always()
      with:
        server_address: smtp.gmail.com
        server_port: 465
        secure: true
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}

        subject: "K8s Trip Simulation Completed (Run ${{ github.run_id }})"
        body: |
          Your Kubernetes Trip Simulation Job has finished.

          Logs and CSV are attached.
          Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

        to: "recipient@example.com"
        from: "sender@example.com"
        attachments: ${{ env.FINAL_LOG }}, ${{ env.FINAL_CSV }}
        