SECRET=$(kubectl get serviceaccount github-deployer -n my-namespace -o jsonpath='{.secrets[0].name}')
TOKEN=$(kubectl get secret $SECRET -n my-namespace -o jsonpath='{.data.token}' | base64 --decode)
CACERT=$(kubectl get secret $SECRET -n my-namespace -o jsonpath='{.data.ca\\.crt}' | base64 --decode)
SERVER=$(kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}')

cat <<EOF > github-kubeconfig
apiVersion: v1
kind: Config
clusters:
- cluster:
    certificate-authority-data: $(echo $CACERT | base64 | tr -d '\n')
    server: $SERVER
  name: github-cluster
contexts:
- context:
    cluster: github-cluster
    user: github-deployer
    namespace: my-namespace
  name: github-context
current-context: github-context
users:
- name: github-deployer
  user:
    token: $TOKEN
EOF
