apiVersion: batch/v1
kind: Job
metadata:
  name: trip-simulation-job
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: trip-simulation
        # Use the image loaded into the KinD cluster
        image: ghcr.io/${{ github.repository_owner }}/trip-simulation:latest 
        
        # Ensure the script is executed in /app (where code is usually placed)
        workingDir: /app 
        
        # This command runs the simulation scripts and outputs all artifacts to the /mnt/artifacts volume
        command: ["/bin/bash", "-c"]
        args:
          - |
            # Exit immediately if a command exits with a non-zero status
            set -e 
            
            echo "--- Starting Trip Simulation and Comparison within K8s Pod ---"
            
            # --- Artifact Paths ---
            CSV_PATH="/mnt/artifacts/trip_a_generated.csv"
            LOG_PATH="/mnt/artifacts/trip_comparison.log"
            
            # --- RUNTIME DIAGNOSTICS (NEW) ---
            echo "Checking contents of working directory (/app):"
            ls -l /app
            
            echo -e "\nChecking Python dependencies (e.g., pandas):"
            # Attempt to import a common library like pandas. If it fails, set -e will trigger exit 1.
            python -c "import pandas; print('Python dependencies check: SUCCESS')"
            
            # --- Check Script Availability ---
            if [ ! -f simulate_trip_a.py ]; then
                echo "FATAL ERROR: simulate_trip_a.py not found in working directory /app."
                exit 1
            fi
            if [ ! -f compare_trips.py ]; then
                echo "FATAL ERROR: compare_trips.py not found in working directory /app."
                exit 1
            fi

            # 1. Run simulation
            echo "Running simulate_trip_a.py, output to: $CSV_PATH"
            # If this command fails or hangs, set -e will immediately stop the script and the Job should fail quickly.
            python simulate_trip_a.py --output-path "$CSV_PATH"
            echo "simulate_trip_a.py completed successfully."
            
            # 2. Run comparison. 
            echo -e "\n--- Running Trip Comparison Results ---\n" > "$LOG_PATH"
            # If this command fails, set -e will stop the script.
            python compare_trips.py 2>&1 >> "$LOG_PATH"
            
            # 3. Final Debugging Check
            echo -e "\n--- Contents of Mounted Artifacts Volume (/mnt/artifacts) ---\n"
            ls -lR /mnt/artifacts
            
            echo -e "\n--- K8s Job Execution Complete ---"
            echo "Artifacts were targeted for: $CSV_PATH and $LOG_PATH"

            # 4. Ensure shell exits gracefully (CRUCIAL FOR K8s COMPLETION)
            exit 0 

        volumeMounts:
        - name: artifact-storage
          mountPath: /mnt/artifacts
      volumes:
      - name: artifact-storage
        # This hostPath corresponds to the directory mounted in the KinD cluster definition
        hostPath:
          path: /mnt/artifacts
          type: DirectoryOrCreate
